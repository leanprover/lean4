- attributes:
    description: Init.Prelude async
    tags: [other]
    time: &time
      #runner: time
      # alternative config: use `perf stat` for extended properties
      runner: perf_stat
      perf_stat:
        properties:
          [
            "wall-clock",
            "task-clock",
            "instructions",
            "branches",
            "branch-misses",
          ]
      rusage_properties: ["maxrss"]
  run_config:
    <<: *time
    cwd: ../../src
    cmd: lean Init/Prelude.lean
- attributes:
    description: Init.Data.List.Sublist async
    tags: [other]
  run_config:
    <<: *time
    cwd: ../../src
    cmd: lean Init/Data/List/Sublist.lean
- attributes:
    description: Std.Data.Internal.List.Associative
    tags: [other]
  run_config:
    <<: *time
    cwd: ../../src
    cmd: lean Std/Data/Internal/List/Associative.lean
- attributes:
    description: Std.Data.DHashMap.Internal.RawLemmas
    tags: [other]
  run_config:
    <<: *time
    cwd: ../../src
    cmd: lean Std/Data/DHashMap/Internal/RawLemmas.lean
- attributes:
    description: Init.Data.BitVec.Lemmas
    tags: [other]
  run_config:
    <<: *time
    cwd: ../../src
    cmd: lean Init/Data/BitVec/Lemmas.lean
- attributes:
    description: Init.Data.List.Sublist re-elab -j4
    tags: [other]
  run_config:
    <<: *time
    cwd: ../../src
    cmd: lean --run ../script/benchReelabRss.lean lean Init/Data/List/Sublist.lean 10 -j4
    max_runs: 2
    parse_output: true
- attributes:
    description: Init.Data.BitVec.Lemmas re-elab
    tags: [other]
  run_config:
    <<: *time
    cwd: ../../src
    cmd: lean --run ../script/benchReelabRss.lean lean Init/Data/BitVec/Lemmas.lean 3 -j4
    max_runs: 2
    parse_output: true
- attributes:
    description: Init.Data.List.Sublist re-elab -j4 (watchdog rss)
    tags: [other]
  run_config:
    <<: *time
    cwd: ../../src
    cmd: lean --run ../script/benchReelabWatchdogRss.lean lean Init/Data/List/Sublist.lean 10 -j4
    max_runs: 2
    parse_output: true
# This benchmark uncovered the promise cycle in `realizeConst` (#11328)
- attributes:
    description: Init.Data.List.Basic re-elab
    tags: [other]
  run_config:
    <<: *time
    cwd: ../../src
    cmd: lean --run ../script/benchReelabRss.lean lean Init/Data/List/Basic.lean 10 -j4
    max_runs: 2
    parse_output: true
- attributes:
    description: import Lean
    tags: [other]
  run_config:
    <<: *time
    cwd: ../../src
    cmd: lean Lean.lean
- attributes:
    description: tests/compiler
    tags: [other]
  run_config:
    cwd: ../compiler/
    cmd: |
      set -eu
      for f in *.lean; do ../bench/compile.sh $f > /dev/null; done
      printf 'sum binary sizes: '
      for f in *.lean; do printf '%s\0' "$f.out"; done | wc -c --files0-from=- | tail -1 | cut -d' ' -f 1
    max_runs: 1
    runner: output
- attributes:
    description: lake build clean
    tags: [other]
  run_config:
    <<: *time
    cmd: |
      bash -c "
      set -ex
      ulimit -s unlimited
      cd inundation
      lake -flakefile-clean.lean clean
      lake -flakefile-clean.lean build
      "
    max_runs: 2
  build_config:
    cmd: |
      bash -c "
      set -ex
      ulimit -s unlimited
      cd inundation
      cp lakefile.lean lakefile-clean.lean
      lake -flakefile-clean.lean -Ktest=Clean run mkBuild
      lake -flakefile-clean.lean build
      "
- attributes:
    description: lake build no-op
    tags: [other]
  run_config:
    <<: *time
    cmd: |
      bash -c "
      set -ex
      ulimit -s unlimited
      lake -dinundation -flakefile-nop.lean build
      "
  build_config:
    cmd: |
      bash -c "
      set -ex
      ulimit -s unlimited
      cd inundation
      cp lakefile.lean lakefile-nop.lean
      lake -flakefile-nop.lean -Ktest=Nop run mkBuild
      lake -flakefile-nop.lean build
      "
- attributes:
    description: lake config elab
    tags: [other]
  run_config:
    <<: *time
    cmd: |
      bash -c "
      set -ex
      ulimit -s unlimited
      lake -dinundation -flakefile-rc.lean -R run nop
      "
  build_config:
    cmd: cp inundation/lakefile.lean inundation/lakefile-rc.lean
- attributes:
    description: lake config import
    tags: [other]
  run_config:
    <<: *time
    cmd: |
      bash -c "
      set -ex
      ulimit -s unlimited
      lake -dinundation run nop
      "
  build_config:
    cmd: |
      bash -c "
      set -ex
      ulimit -s unlimited
      lake -dinundation run nop
      "
- attributes:
    description: lake config tree
    tags: [other]
  run_config:
    <<: *time
    cmd: |
      bash -c "
      set -ex
      ulimit -s unlimited
      lake -dinundation/test/tree run nop
      "
  build_config:
    cmd: |
      lake -dinundation run mkTree
      lake -dinundation/test/tree update
- attributes:
    description: lake env
    tags: [other]
  run_config:
    <<: *time
    cmd: |
      bash -c "
      set -ex
      ulimit -s unlimited
      lake -dinundation env true
      "
  build_config:
    cmd: lake -dinundation env true
- attributes:
    description: lake startup
    tags: [other]
  run_config:
    <<: *time
    cmd: |
      bash -c "
      set -ex
      ulimit -s unlimited
      lake self-check
      "
- attributes:
    description: leanchecker --fresh Init
    tags: [other]
  run_config:
    <<: *time
    cmd: leanchecker --fresh Init
    max_runs: 1
